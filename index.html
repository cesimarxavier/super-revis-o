<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mestres do Saber - A Lenda de Cognitia</title>

    <meta name="theme-color" content="#4ECDC4">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Fredoka', 'sans-serif'] },
                    colors: {
                        'brand-purple': '#7C3AED',
                        'brand-blue': '#4ECDC4',
                        'brand-yellow': '#FFD166',
                        'brand-red': '#EF476F',
                        'brand-dark': '#1A535C',
                        'ui-bg': '#F7F9FC',
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                        'pulse-slow': 'pulse 3s infinite',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        pop: { '0%': { transform: 'scale(0.8)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(50px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F7F9FC;
            background-image: radial-gradient(#E2E8F0 2px, transparent 2px);
            background-size: 24px 24px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 120px;
        }

        .btn-game {
            transition: all 0.1s;
            border-bottom-width: 5px;
            transform: translateY(0);
        }

        .btn-game:active {
            transform: translateY(5px);
            border-bottom-width: 0px;
            box-shadow: none !important;
        }

        .hidden-screen {
            display: none !important;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        .avatar-glow {
            box-shadow: 0 0 20px rgba(124, 58, 237, 0.4);
        }

        /* Estilo para bloqueado */
        .locked-filter {
            filter: grayscale(1);
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* estilo.css */

        /* Define que as bordas de c√©lulas adjacentes se fundam em uma √∫nica borda */
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 1rem;
            /* Espa√ßamento acima da tabela */
            background-color: #fff;
        }

        /* Estilo padr√£o para todas as c√©lulas de cabe√ßalho e corpo */
        th,
        td {
            padding: 12px 24px;
            /* Espa√ßamento interno */
            text-align: left;
            border: 1px solid #383b42;
            /* Borda fina e cinza clara */
            vertical-align: middle;
        }

        /* Estilo espec√≠fico para o cabe√ßalho (<thead>) */
        thead th {
            background-color: #f9fafb;
            /* Fundo cinza claro */
            font-size: 0.75rem;
            /* Tamanho de fonte pequeno */
            font-weight: 500;
            color: #6b7280;
            /* Cor do texto */
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        /* Linhas do corpo (<tbody>) */
        tbody tr {
            border-bottom: 1px solid #e5e7eb;
            /* Apenas borda inferior para divis√≥ria */
        }

        /* Efeito de hover nas linhas (mudar cor de fundo ao passar o mouse) */
        tbody tr:hover {
            background-color: #f9fafb;
        }
    </style>
</head>

<body class="text-gray-700 min-h-screen flex flex-col items-center overflow-x-hidden">

    <header id="main-header"
        class="fixed top-0 w-full z-50 glass-panel shadow-sm px-4 py-2 transition-transform duration-300 hidden-screen">
        <div class="max-w-xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2 bg-white rounded-full p-1 pr-4 border border-gray-100 shadow-sm cursor-pointer"
                onclick="UI.showProfile()">
                <div class="w-10 h-10 rounded-full bg-brand-purple flex items-center justify-center text-xl border-2 border-white avatar-glow"
                    id="header-avatar"><svg viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <!-- Gradientes para dar profundidade -->
                            <linearGradient id="skyGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#6B5DD3;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#4A3B9F;stop-opacity:1" />
                            </linearGradient>

                            <linearGradient id="wallGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#E8D5F2;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#C9A8DC;stop-opacity:1" />
                            </linearGradient>

                            <linearGradient id="roofGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#FF6B9D;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#D44A7A;stop-opacity:1" />
                            </linearGradient>

                            <linearGradient id="doorGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#6B4AC9;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#4A2F8A;stop-opacity:1" />
                            </linearGradient>

                            <!-- Anima√ß√µes -->
                            <style>
                                @keyframes float {

                                    0%,
                                    100% {
                                        transform: translateY(0px);
                                    }

                                    50% {
                                        transform: translateY(-8px);
                                    }
                                }

                                @keyframes wave {

                                    0%,
                                    100% {
                                        transform: rotate(0deg);
                                    }

                                    25% {
                                        transform: rotate(5deg);
                                    }

                                    75% {
                                        transform: rotate(-5deg);
                                    }
                                }

                                @keyframes sparkle {

                                    0%,
                                    100% {
                                        opacity: 1;
                                        transform: scale(1);
                                    }

                                    50% {
                                        opacity: 0.4;
                                        transform: scale(0.8);
                                    }
                                }

                                @keyframes glow {

                                    0%,
                                    100% {
                                        opacity: 0.6;
                                    }

                                    50% {
                                        opacity: 1;
                                    }
                                }

                                .castle-main {
                                    animation: float 3s ease-in-out infinite;
                                }

                                .flag {
                                    animation: wave 2s ease-in-out infinite;
                                    transform-origin: bottom left;
                                }

                                .sparkle {
                                    animation: sparkle 1.5s ease-in-out infinite;
                                }

                                .window-glow {
                                    animation: glow 2s ease-in-out infinite;
                                }
                            </style>
                        </defs>

                        <!-- Fundo c√©u -->
                        <rect width="300" height="300" fill="url(#skyGrad)" />

                        <!-- Estrelas decorativas -->
                        <circle class="sparkle" cx="40" cy="40" r="2" fill="#FFD700" style="animation-delay: 0s;" />
                        <circle class="sparkle" cx="260" cy="60" r="2.5" fill="#FFD700"
                            style="animation-delay: 0.5s;" />
                        <circle class="sparkle" cx="80" cy="80" r="1.5" fill="#FFF" style="animation-delay: 1s;" />
                        <circle class="sparkle" cx="240" cy="100" r="2" fill="#FFF" style="animation-delay: 0.3s;" />

                        <!-- Castelo principal -->
                        <g class="castle-main">
                            <!-- Torres laterais -->
                            <!-- Torre esquerda -->
                            <g>
                                <!-- Corpo da torre -->
                                <rect x="40" y="140" width="50" height="90" fill="url(#wallGrad)" stroke="#9D7BB8"
                                    stroke-width="2" />
                                <rect x="42" y="142" width="46" height="10" fill="#F5E6FF" opacity="0.5" />

                                <!-- Telhado c√¥nico -->
                                <path d="M 35 140 L 65 100 L 95 140 Z" fill="url(#roofGrad)" stroke="#B83870"
                                    stroke-width="2" />
                                <ellipse cx="65" cy="140" rx="30" ry="8" fill="#D4568A" />

                                <!-- Decora√ß√£o topo -->
                                <circle cx="65" cy="95" r="6" fill="#FFD700" stroke="#FFA500" stroke-width="2" />

                                <!-- Janela -->
                                <rect x="55" y="170" width="20" height="25" rx="10" fill="url(#doorGrad)"
                                    stroke="#8A5CC6" stroke-width="2" />
                                <rect class="window-glow" x="57" y="172" width="16" height="21" rx="8" fill="#A78BFA"
                                    opacity="0.6" />
                            </g>

                            <!-- Torre direita -->
                            <g>
                                <!-- Corpo da torre -->
                                <rect x="210" y="140" width="50" height="90" fill="url(#wallGrad)" stroke="#9D7BB8"
                                    stroke-width="2" />
                                <rect x="212" y="142" width="46" height="10" fill="#F5E6FF" opacity="0.5" />

                                <!-- Telhado c√¥nico -->
                                <path d="M 205 140 L 235 100 L 265 140 Z" fill="url(#roofGrad)" stroke="#B83870"
                                    stroke-width="2" />
                                <ellipse cx="235" cy="140" rx="30" ry="8" fill="#D4568A" />

                                <!-- Decora√ß√£o topo -->
                                <circle cx="235" cy="95" r="6" fill="#FFD700" stroke="#FFA500" stroke-width="2" />

                                <!-- Janela -->
                                <rect x="225" y="170" width="20" height="25" rx="10" fill="url(#doorGrad)"
                                    stroke="#8A5CC6" stroke-width="2" />
                                <rect class="window-glow" x="227" y="172" width="16" height="21" rx="8" fill="#A78BFA"
                                    opacity="0.6" />
                            </g>

                            <!-- Torre central (principal) -->
                            <g>
                                <!-- Corpo principal -->
                                <rect x="100" y="120" width="100" height="110" fill="url(#wallGrad)" stroke="#9D7BB8"
                                    stroke-width="3" />
                                <rect x="103" y="123" width="94" height="15" fill="#F5E6FF" opacity="0.5" />

                                <!-- Ameias decorativas -->
                                <rect x="100" y="120" width="15" height="20" fill="#D4B3E8" stroke="#9D7BB8"
                                    stroke-width="2" />
                                <rect x="125" y="120" width="15" height="20" fill="#D4B3E8" stroke="#9D7BB8"
                                    stroke-width="2" />
                                <rect x="160" y="120" width="15" height="20" fill="#D4B3E8" stroke="#9D7BB8"
                                    stroke-width="2" />
                                <rect x="185" y="120" width="15" height="20" fill="#D4B3E8" stroke="#9D7BB8"
                                    stroke-width="2" />

                                <!-- Telhado principal -->
                                <path d="M 90 120 L 150 60 L 210 120 Z" fill="url(#roofGrad)" stroke="#B83870"
                                    stroke-width="3" />
                                <ellipse cx="150" cy="120" rx="60" ry="10" fill="#D4568A" />

                                <!-- Bandeira no topo -->
                                <line x1="150" y1="60" x2="150" y2="30" stroke="#8B5CF6" stroke-width="3" />
                                <path class="flag" d="M 150 35 L 180 40 L 150 45 Z" fill="#FF6B9D" stroke="#D4568A"
                                    stroke-width="1.5" />

                                <!-- Estrela no topo da bandeira -->
                                <circle cx="150" cy="28" r="5" fill="#FFD700" stroke="#FFA500" stroke-width="2" />

                                <!-- Porta principal -->
                                <path d="M 130 180 Q 130 160 150 160 Q 170 160 170 180 L 170 230 L 130 230 Z"
                                    fill="url(#doorGrad)" stroke="#6B4AC9" stroke-width="3" />
                                <ellipse cx="150" cy="180" rx="20" ry="8" fill="#4A2F8A" />

                                <!-- Detalhes da porta -->
                                <circle cx="160" cy="205" r="3" fill="#FFD700" />
                                <rect x="148" y="165" width="4" height="60" fill="#5B3BA0" opacity="0.5" />

                                <!-- Janelas laterais -->
                                <rect x="110" y="160" width="15" height="20" rx="7" fill="url(#doorGrad)"
                                    stroke="#8A5CC6" stroke-width="2" />
                                <rect class="window-glow" x="112" y="162" width="11" height="16" rx="5" fill="#A78BFA"
                                    opacity="0.6" />

                                <rect x="175" y="160" width="15" height="20" rx="7" fill="url(#doorGrad)"
                                    stroke="#8A5CC6" stroke-width="2" />
                                <rect class="window-glow" x="177" y="162" width="11" height="16" rx="5" fill="#A78BFA"
                                    opacity="0.6" />
                            </g>

                            <!-- Decora√ß√µes adicionais -->
                            <!-- Bandeiras nas torres laterais -->
                            <g>
                                <line x1="65" y1="95" x2="65" y2="75" stroke="#8B5CF6" stroke-width="2" />
                                <path class="flag" d="M 65 78 L 85 82 L 65 86 Z" fill="#4ADEEF" stroke="#2CB8CC"
                                    stroke-width="1" style="animation-delay: 0.5s;" />
                            </g>

                            <g>
                                <line x1="235" y1="95" x2="235" y2="75" stroke="#8B5CF6" stroke-width="2" />
                                <path class="flag" d="M 235 78 L 255 82 L 235 86 Z" fill="#4ADEEF" stroke="#2CB8CC"
                                    stroke-width="1" style="animation-delay: 0.7s;" />
                            </g>
                        </g>

                        <!-- Sombra -->
                        <ellipse cx="150" cy="235" rx="110" ry="10" fill="#000" opacity="0.15" />
                    </svg></div>
                <div class="flex flex-col leading-none">
                    <span class="text-[10px] font-bold text-gray-400 uppercase">Guardi√£o</span>
                    <span class="text-sm font-bold text-brand-dark truncate w-20" id="header-nick">Jogador</span>
                </div>
            </div>

            <div class="flex gap-2">
                <div
                    class="flex items-center gap-1 bg-brand-yellow/20 px-3 py-1 rounded-full border border-brand-yellow">
                    <span>ü™ô</span>
                    <span class="font-bold text-yellow-700 text-sm" id="header-coins">0</span>
                </div>
                <div class="flex items-center gap-1 bg-brand-blue/20 px-3 py-1 rounded-full border border-brand-blue">
                    <span>üíé</span>
                    <span class="font-bold text-teal-700 text-sm" id="header-gems">0</span>
                </div>
            </div>
        </div>
    </header>

    <main id="game-container" class="w-full max-w-xl flex-grow flex flex-col pt-20 px-4">

        <section id="screen-result" class="hidden-screen w-full pb-24">
            <div id="result-container"></div>
        </section>

        <section id="screen-intro"
            class="flex flex-col items-center justify-center min-h-[80vh] text-center animate-slide-up">
            <div class="mb-8 relative">
                <div class="absolute inset-0 bg-brand-purple blur-3xl opacity-20 rounded-full"></div>
                <div class="text-8xl animate-float relative z-10">üè∞</div>
            </div>
            <h1 class="text-4xl font-black text-brand-dark mb-2">Mestres do Saber</h1>
            <p class="text-gray-500 mb-8 max-w-xs mx-auto">Salve o reino de Cognitia das Sombras do Esquecimento!</p>

            <div class="bg-white p-6 rounded-3xl shadow-xl w-full border-b-8 border-gray-100">
                <label class="block text-left text-sm font-bold text-gray-400 mb-2 uppercase">Como devo te
                    chamar?</label>
                <input type="text" id="input-nick" placeholder="Ex: Super Sofia" maxlength="12"
                    class="w-full text-center text-2xl font-bold p-4 bg-gray-50 rounded-2xl border-2 border-gray-200 focus:border-brand-purple focus:outline-none text-brand-purple mb-4 transition-all">

                <button onclick="Game.startAdventure()"
                    class="w-full bg-brand-purple hover:bg-purple-600 text-white font-bold py-4 rounded-2xl text-xl btn-game shadow-lg shadow-purple-200">
                    Come√ßar Aventura üöÄ
                </button>
            </div>
        </section>

        <section id="screen-map" class="hidden-screen w-full pb-24">
            <div class="text-center mb-6">
                <span
                    class="inline-block px-3 py-1 rounded-full bg-brand-dark text-white text-xs font-bold uppercase tracking-widest mb-2">Mapa
                    Mundi</span>
                <h2 class="text-2xl font-black text-gray-800">Escolha seu Destino</h2>
            </div>

            <div class="grid grid-cols-2 gap-4" id="subjects-grid">
            </div>
        </section>

        <section id="screen-subject" class="hidden-screen w-full pb-24">
            <button onclick="UI.showScreen('screen-map')"
                class="mb-4 text-sm font-bold text-gray-400 hover:text-gray-600 flex items-center gap-1">
                ‚¨Ö Voltar ao Mapa
            </button>

            <div id="subject-header"
                class="mb-8 text-center p-6 bg-white rounded-3xl shadow-sm border-b-4 border-gray-100">
            </div>

            <div class="space-y-4" id="categories-list">
            </div>
        </section>

        <section id="screen-prep"
            class="hidden-screen w-full z-50 fixed inset-0 bg-black/50 backdrop-blur-sm flex items-end sm:items-center justify-center">
            <div
                class="bg-white w-full max-w-lg h-[85vh] sm:h-auto sm:rounded-3xl rounded-t-3xl p-6 flex flex-col animate-slide-up relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-brand-purple to-brand-blue"></div>
                <button onclick="UI.closePrep()"
                    class="absolute top-4 right-4 bg-gray-100 rounded-full w-8 h-8 flex items-center justify-center font-bold text-gray-500">‚úï</button>

                <div class="overflow-y-auto flex-grow pr-2 custom-scroll">
                    <div class="text-center mt-4">
                        <div class="text-6xl mb-4 animate-bounce" id="prep-icon">üìú</div>
                        <h2 class="text-2xl font-black text-gray-800 mb-2" id="prep-title">T√≠tulo</h2>
                        <div class="prose text-gray-600 leading-relaxed text-lg" id="prep-content">
                        </div>
                    </div>

                    <div class="mt-8 bg-yellow-50 p-4 rounded-2xl border-2 border-yellow-200 flex items-center gap-4">
                        <div class="text-4xl">üéÅ</div>
                        <div>
                            <p class="text-xs font-bold text-yellow-600 uppercase">Recompensa de Estudo</p>
                            <p class="font-bold text-yellow-800" id="prep-reward-text">Skin: Mago S√°bio</p>
                        </div>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-gray-100">
                    <button onclick="Game.finishPrep()"
                        class="w-full bg-brand-green hover:bg-green-600 text-white font-bold py-4 rounded-2xl text-xl btn-game shadow-lg bg-green-500 border-green-600">
                        Estou Pronto! ‚öîÔ∏è
                    </button>
                </div>
            </div>
        </section>

        <section id="screen-game" class="hidden-screen w-full pb-32">
            <div class="flex justify-between items-center mb-6">
                <button onclick="Game.exitGame()"
                    class="bg-gray-100 hover:bg-red-100 hover:text-red-500 text-gray-500 px-4 py-2 rounded-xl font-bold text-sm transition-colors flex items-center gap-2">
                    ‚úï Sair
                </button>
                <div class="text-xs font-bold text-white bg-brand-purple/80 px-3 py-1 rounded-full uppercase tracking-wider"
                    id="game-level-tag">N√çVEL 1</div>
            </div>

            <div class="flex items-center gap-4 mb-6">
                <div class="flex gap-1 text-2xl min-w-[80px]" id="game-hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                <div class="flex-grow bg-gray-200 rounded-full h-3">
                    <div id="game-progress"
                        class="bg-brand-purple h-3 rounded-full transition-all duration-500 shadow-sm"
                        style="width: 0%"></div>
                </div>
            </div>

            <div
                class="bg-white rounded-3xl p-6 shadow-lg border-b-8 border-gray-100 relative overflow-hidden min-h-[300px] flex flex-col justify-center">
                <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl rotate-12">‚ùì</div>
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 text-center leading-snug mb-6"
                    id="game-question">...</h2>

                <div class="grid gap-3" id="game-options">
                </div>
            </div>
        </section>
    </main>

    <div id="footer-action"
        class="fixed bottom-0 left-0 w-full bg-white border-t-2 border-gray-100 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] p-4 z-40 hidden-screen">
        <div class="max-w-xl mx-auto" id="footer-content">
        </div>
    </div>

    <script src="database.js"></script>
    <script>
        /* * MESTRES DO SABER - ENGINE V2.1 (Com Sistema Anti-Repeti√ß√£o Inteligente) */

        // --- 2. STATE MANAGEMENT ---
        const State = {
            data: {
                nick: "",
                coins: 0,
                gems: 0,
                skins: ["üßô‚Äç‚ôÇÔ∏è"],
                currentSkin: "üßô‚Äç‚ôÇÔ∏è",
                progress: {},
                attempts: {},
                history: [] // Lista de IDs j√° respondidos: [1, 2, 5, 99...]
            },

            load: function () {
                const saved = localStorage.getItem('mestres_save_v3'); // Mudei vers√£o para v3
                if (saved) {
                    this.data = JSON.parse(saved);
                    if (!this.data.history) this.data.history = []; // Migra√ß√£o segura
                    return true;
                }
                return false;
            },

            save: function () {
                localStorage.setItem('mestres_save_v3', JSON.stringify(this.data));
                UI.updateHeader();
            },

            // --- NOVA FUN√á√ÉO: REGISTRAR HIST√ìRICO ---
            addToHistory: function (questionIds) {
                // Adiciona apenas IDs novos
                questionIds.forEach(id => {
                    if (!this.data.history.includes(id)) {
                        this.data.history.push(id);
                    }
                });
                this.save();
            },

            // --- NOVA FUN√á√ÉO: CHECAR SE PRECISA RESETAR ---
            // Se o aluno j√° viu todas as perguntas f√°ceis, limpamos o hist√≥rico daquele n√≠vel
            // para ele poder jogar de novo sem travar.
            cleanHistoryForPool: function (poolIds) {
                this.data.history = this.data.history.filter(id => !poolIds.includes(id));
                this.save();
            },

            registerAttempt: function (catId, lvlIdx, passed) {
                const key = `${catId}-lvl${lvlIdx}`;
                if (!this.data.attempts[key]) this.data.attempts[key] = { count: 0, timestamp: 0 };

                if (passed) {
                    this.data.attempts[key].count = 0;
                } else {
                    this.data.attempts[key].count++;
                    this.data.attempts[key].timestamp = Date.now();
                }
                this.save();
            },

            getAttemptStatus: function (catId, lvlIdx) {
                const key = `${catId}-lvl${lvlIdx}`;
                const att = this.data.attempts[key];
                if (!att) return { locked: false, count: 0 };

                if (att.count >= 2) { // Bloqueia na 3¬™ tentativa (depois de 2 erros)
                    const now = Date.now();
                    const diff = now - att.timestamp;
                    const hours24 = 24 * 60 * 60 * 1000;

                    if (diff < hours24) {
                        const timeLeft = Math.ceil((hours24 - diff) / (60 * 60 * 1000));
                        return { locked: true, timeLeft: timeLeft };
                    } else {
                        att.count = 0; // Reset ap√≥s 24h
                        this.save();
                        return { locked: false, count: 0 };
                    }
                }
                return { locked: false, count: att.count };
            },

            unlockSkin: function (skin) {
                if (!this.data.skins.includes(skin)) {
                    this.data.skins.push(skin);
                    this.data.currentSkin = skin;
                    this.save();
                    alert(`Nova Skin Desbloqueada: ${skin}`);
                }
            },

            checkLevelUnlock: function (catId, levelIdx) {
                if (levelIdx === 0) return true;
                return this.data.progress[`${catId}-lvl${levelIdx - 1}`] === true;
            }
        };

        // --- 3. UI MANAGER (Mantida igual, apenas adicionei prote√ß√µes) ---
        const UI = {
            screens: ['screen-intro', 'screen-map', 'screen-subject', 'screen-game', 'screen-result'],

            showScreen: function (id) {
                this.screens.forEach(s => {
                    const el = document.getElementById(s);
                    if (el) el.classList.add('hidden-screen');
                });
                const target = document.getElementById(id);
                if (target) {
                    target.classList.remove('hidden-screen');
                    target.classList.add('animate-slide-up');
                }
                const header = document.getElementById('main-header');
                const footer = document.getElementById('footer-action');

                if (id === 'screen-intro') {
                    if (header) header.classList.add('hidden-screen');
                    if (footer) footer.classList.add('hidden-screen');
                } else {
                    if (header) header.classList.remove('hidden-screen');
                    this.updateHeader();
                }
            },

            updateHeader: function () {
                document.getElementById('header-nick').innerText = State.data.nick;
                document.getElementById('header-avatar').innerText = State.data.currentSkin;
                document.getElementById('header-coins').innerText = State.data.coins;
                document.getElementById('header-gems').innerText = State.data.gems;
            },

            renderMap: function () {
                const grid = document.getElementById('subjects-grid');
                if (!grid) return;
                grid.innerHTML = '';
                DB.subjects.forEach(sub => {
                    grid.innerHTML += `
                <div onclick="Game.openSubject('${sub.id}')" 
                    class="bg-white p-4 rounded-3xl shadow-sm border-b-4 border-gray-100 active:scale-95 transition-transform cursor-pointer relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-2 opacity-10 text-6xl group-hover:scale-110 transition-transform">${sub.icon}</div>
                    <div class="${sub.color} w-12 h-12 rounded-2xl flex items-center justify-center text-2xl text-white shadow-md mb-3">
                        ${sub.icon}
                    </div>
                    <h3 class="font-bold text-gray-700 leading-tight">${sub.name}</h3>
                    <p class="text-xs text-gray-400 font-bold uppercase mt-1">
                        ${sub.categories.length} Aventuras
                    </p>
                </div>`;
                });
                this.showScreen('screen-map');
            },

            renderSubject: function (subId) {
                const sub = DB.subjects.find(s => s.id === subId);
                const container = document.getElementById('categories-list');
                const header = document.getElementById('subject-header');

                header.innerHTML = `
                <div class="text-6xl mb-2 animate-float">${sub.icon}</div>
                <h2 class="text-3xl font-black text-gray-800">${sub.name}</h2>
                <p class="text-gray-500">Complete os desafios!</p>
            `;

                container.innerHTML = '';
                sub.categories.forEach(cat => {
                    let levelsHTML = '';
                    const levels = [
                        { name: "Iniciante", class: "bg-blue-100 text-blue-700 border-blue-200", icon: "üê£", bloomMax: 2 },
                        { name: "Aventureiro", class: "bg-green-100 text-green-700 border-green-200", icon: "‚öîÔ∏è", bloomMax: 4 },
                        { name: "Tit√£", class: "bg-purple-100 text-purple-700 border-purple-200", icon: "üëπ", bloomMax: 6 },
                        { name: "Mestre", class: "bg-yellow-100 text-yellow-700 border-yellow-200", icon: "üëë", bloomMax: 7 }
                    ];

                    levels.forEach((lvl, idx) => {
                        const isUnlocked = State.checkLevelUnlock(cat.id, idx);
                        const isDone = State.data.progress[`${cat.id}-lvl${idx}`];
                        const attemptStatus = State.getAttemptStatus(cat.id, idx);

                        let statusIcon = isUnlocked ? (isDone ? "‚úÖ" : lvl.icon) : "üîí";
                        let btnStyle = isUnlocked ? lvl.class : "bg-gray-100 text-gray-400 border-gray-200 opacity-60";

                        if (attemptStatus.locked) {
                            statusIcon = "‚è≥";
                            btnStyle = "bg-gray-200 text-gray-500 border-gray-300 locked-filter";
                        }

                        levelsHTML += `
                        <button onclick="${isUnlocked && !attemptStatus.locked ? `Game.startLevel('${cat.id}', ${idx}, ${lvl.bloomMax})` : `Game.showLockMessage(${attemptStatus.locked}, ${attemptStatus.timeLeft})`}"
                            class="flex-1 py-3 rounded-xl border-b-4 text-xs font-bold transition-transform active:scale-95 ${btnStyle}">
                            <div class="text-lg mb-1">${statusIcon}</div>
                            ${lvl.name}
                        </button>
                    `;
                    });

                    container.innerHTML += `
                    <div class="bg-white rounded-3xl p-5 shadow-sm border-2 border-gray-100">
                        <div class="flex justify-between items-center mb-4">
                            <div><h3 class="font-bold text-lg text-gray-700">${cat.name}</h3></div>
                            <button onclick="Game.openPrep('${cat.id}')" class="bg-brand-yellow text-yellow-800 px-4 py-2 rounded-xl font-bold text-sm shadow-sm hover:bg-yellow-400">
                                <span>üìú</span> Preparar
                            </button>
                        </div>
                        <div class="flex gap-2 w-full">${levelsHTML}</div>
                    </div>`;
                });
                this.showScreen('screen-subject');
            },

            openPrepModal: function (content) {
                document.getElementById('prep-icon').innerText = content.skin;
                document.getElementById('prep-title').innerHTML = content.title;
                document.getElementById('prep-content').innerHTML = content.content;
                document.getElementById('prep-reward-text').innerText = `Skin: ${content.skin}`;
                document.getElementById('screen-prep').classList.remove('hidden-screen');
            },

            closePrep: function () {
                document.getElementById('screen-prep').classList.add('hidden-screen');
            },

            renderGameScreen: function (q, total, current, lives) {
                this.showScreen('screen-game');
                const pct = ((current) / total) * 100;
                document.getElementById('game-progress').style.width = `${pct}%`;
                let hearts = '';
                for (let i = 0; i < lives; i++) hearts += '‚ù§Ô∏è';
                document.getElementById('game-hearts').innerText = hearts;
                document.getElementById('game-question').innerHTML = q.q.replace(/\*\*(.*?)\*\*/g, '<span class="text-brand-purple">$1</span>').replace(/______/g, '<span class="border-b-4 border-gray-300 w-16 inline-block"></span>');

                const optsContainer = document.getElementById('game-options');
                optsContainer.innerHTML = '';
                q.opts.forEach((opt, idx) => {
                    optsContainer.innerHTML += `
                    <button onclick="Game.selectOption(${idx})" id="opt-${idx}"
                        class="w-full text-left p-4 rounded-2xl border-2 border-gray-200 bg-gray-50 font-bold text-gray-600 transition-all active:scale-95 btn-game">
                        ${opt}
                    </button>`;
                });

                const footer = document.getElementById('footer-action');
                footer.classList.remove('hidden-screen');
                footer.innerHTML = `<div class="max-w-xl mx-auto"><button class="w-full bg-gray-200 text-gray-400 font-bold py-4 rounded-2xl text-lg cursor-not-allowed" disabled>Escolha uma resposta</button></div>`;
            },

            showFeedback: function (isCorrect, hint, nextFn) {
                const footer = document.getElementById('footer-action');
                const color = isCorrect ? 'green' : 'red';
                const title = isCorrect ? 'INCR√çVEL!' : 'CORRE√á√ÉO:';

                footer.innerHTML = `
                <div class="max-w-xl mx-auto flex flex-col gap-3 animate-slide-up">
                    <div class="flex items-start gap-3 bg-${color}-50 p-4 rounded-2xl border border-${color}-100">
                        <div class="text-3xl">${isCorrect ? 'üéâ' : 'üí°'}</div>
                        <div>
                            <p class="font-black text-${color}-600 uppercase text-sm">${title}</p>
                            <p class="text-gray-600 font-medium leading-tight">${hint}</p>
                        </div>
                    </div>
                    <button onclick="${nextFn}" class="w-full bg-${color}-500 hover:bg-${color}-600 text-white font-bold py-4 rounded-2xl text-xl btn-game shadow-lg">
                        ${isCorrect ? 'CONTINUAR' : 'ENTENDI'}
                    </button>
                </div>`;
            },

            showResult: function (isVictory, score, totalQuestions, retryFn, mapFn) {
                const container = document.getElementById('result-container');
                const footer = document.getElementById('footer-action');
                if (footer) footer.classList.add('hidden-screen');

                // C√°lculo da porcentagem (usando acertos/total)
                // Nota: Se cada quest√£o vale 10, total score possivel √© 50.
                const percentage = Math.round((score / (totalQuestions * 10)) * 100);

                try { if (typeof confetti === 'function' && isVictory) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } }); } catch (e) { }

                container.innerHTML = `
            <div class="flex flex-col items-center justify-center h-full pt-10 animate-pop px-4">
                <div class="text-8xl mb-4 animate-bounce">${isVictory ? 'üèÜ' : 'üê¢'}</div>
                <h2 class="text-3xl font-black text-gray-800 mb-2">${isVictory ? 'Vit√≥ria √âpica!' : 'N√£o desista!'}</h2>
                <p class="text-gray-500 mb-6 text-center">
                    ${isVictory ? 'Voc√™ provou ser um Mestre!' : 'Voc√™ precisa de 70% para passar.'}
                </p>
                
                <div class="bg-white p-6 rounded-3xl shadow-sm border-b-4 border-gray-100 w-full mb-6 text-center">
                    <p class="text-sm font-bold text-gray-400 uppercase">Sua Nota</p>
                    <p class="text-5xl font-black ${isVictory ? 'text-brand-purple' : 'text-brand-red'}">${percentage}%</p>
                    <p class="text-xs text-gray-400 mt-2">M√≠nimo para passar: 70%</p>
                </div>

                ${isVictory ? `
                    <div class="flex gap-4 w-full mb-8">
                        <div class="flex-1 bg-yellow-50 p-4 rounded-2xl border-2 border-yellow-200 flex flex-col items-center">
                            <span class="text-xl">ü™ô</span>
                            <span class="font-bold text-yellow-800 text-sm">+20 Coins</span>
                        </div>
                    </div>` : ''
                    }

                <div class="w-full space-y-3">
                    ${!isVictory ? `
                    <button onclick="${retryFn}" class="w-full bg-brand-yellow text-yellow-900 font-bold py-4 rounded-2xl text-xl btn-game shadow-lg">
                        Tentar Novamente üîÑ
                    </button>` : ''}
                    
                    <button onclick="${mapFn}" class="w-full bg-gray-200 text-gray-600 font-bold py-4 rounded-2xl text-xl btn-game">
                        Voltar ao Mapa
                    </button>
                </div>
            </div>`;

                this.showScreen('screen-result');
            }
        };

        // --- 4. GAME ENGINE LOGIC ---
        const Game = {
            currentSession: null,

            exitGame: function () {
                if (confirm("Tem certeza que quer sair? Todo o progresso desta fase ser√° perdido! üõ°Ô∏è")) {
                    // Cancela a sess√£o atual
                    this.currentSession = null;
                    // Volta para a tela da mat√©ria atual (para escolher outro n√≠vel)
                    // Precisamos saber qual era a mat√©ria. Vamos pegar do ID da categoria.
                    // O ID √© tipo "pt-pronomes-lvl1". O prefixo "pt" √© a mat√©ria.
                    // Mas como temos a tela de subject aberta por baixo, basta renderizar ela de novo.

                    // Recupera o ID da mat√©ria pelo ID da categoria atual ou volta pro mapa
                    // Op√ß√£o segura: Voltar para o Mapa
                    UI.renderMap();
                }
            },

            startAdventure: function () {
                const nick = document.getElementById('input-nick').value;
                if (nick.length < 3) return alert("O nome precisa ter pelo menos 3 letras!");
                State.data.nick = nick;
                State.save();
                UI.renderMap();
            },

            openSubject: function (id) { UI.renderSubject(id); },

            openPrep: function (catId) {
                let category = null;
                DB.subjects.forEach(s => {
                    const c = s.categories.find(k => k.id === catId);
                    if (c) category = c;
                });
                this.tempSkin = category.prep.skin;
                UI.openPrepModal(category.prep);
            },

            finishPrep: function () {
                State.unlockSkin(this.tempSkin);
                State.data.coins += 10;
                State.save();
                UI.closePrep();
                try { confetti({ particleCount: 50, spread: 50 }); } catch (e) { }
            },

            showLockMessage: function (locked, time) {
                if (locked) {
                    alert(`Voc√™ precisa descansar! Esse n√≠vel est√° bloqueado por mais ${time} horas.`);
                } else {
                    alert("Complete o n√≠vel anterior para desbloquear este.");
                }
            },

            startLevel: function (catId, levelIdx, bloomMax) {
                let category = null;
                DB.subjects.forEach(s => {
                    const c = s.categories.find(k => k.id === catId);
                    if (c) category = c;
                });

                let minBloom = bloomMax - 1;
                if (levelIdx === 0) minBloom = 1;

                // --- L√ìGICA DE SORTEIO COM MEM√ìRIA (Deck de Cartas) ---

                // 1. Pega todas as quest√µes poss√≠veis para o n√≠vel
                const fullPool = category.pool.filter(q => q.bloom >= minBloom && q.bloom <= bloomMax);

                // 2. Filtra as que o usu√°rio AINDA N√ÉO VIU (In√©ditas)
                let freshQuestions = fullPool.filter(q => !State.data.history.includes(q.id));

                // 3. Se tiver menos de 5 in√©ditas, precisamos reciclar!
                if (freshQuestions.length < 5) {
                    // Remove os IDs desse pool espec√≠fico do hist√≥rico global para que eles "apare√ßam" de novo
                    // Basicamente, "embaralha o baralho" de novo
                    const poolIds = fullPool.map(q => q.id);
                    State.cleanHistoryForPool(poolIds);

                    // Pega de novo (agora todas estar√£o 'fresh')
                    freshQuestions = fullPool;
                }

                // 4. Sorteia e Pega 5
                const shuffled = freshQuestions.sort(() => 0.5 - Math.random());
                const selectedQuestions = shuffled.slice(0, 5);

                if (selectedQuestions.length === 0) {
                    return alert("Erro: Sem quest√µes dispon√≠veis no banco de dados.");
                }

                this.currentSession = {
                    catId: catId,
                    levelIdx: levelIdx,
                    questions: selectedQuestions,
                    questionIds: selectedQuestions.map(q => q.id), // Guardar IDs para salvar no fim
                    idx: 0,
                    lives: 3,
                    score: 0,
                    totalQuestions: 5,
                    correctCount: 0
                };

                UI.renderGameScreen(selectedQuestions[0], 5, 0, 3);
            },

            selectOption: function (optIdx) {
                const btns = document.querySelectorAll('[id^="opt-"]');
                btns.forEach(b => {
                    b.classList.replace('border-brand-purple', 'border-gray-200');
                    b.classList.replace('bg-purple-50', 'bg-gray-50');
                });
                const selected = document.getElementById(`opt-${optIdx}`);
                selected.classList.replace('border-gray-200', 'border-brand-purple');
                selected.classList.replace('bg-gray-50', 'bg-purple-50');
                this.currentSession.selectedOpt = optIdx;

                const footer = document.getElementById('footer-action');
                footer.innerHTML = `<div class="max-w-xl mx-auto"><button onclick="Game.checkAnswer()" class="w-full bg-brand-purple hover:bg-purple-600 text-white font-bold py-4 rounded-2xl text-xl btn-game shadow-lg">CONFIRMAR</button></div>`;
            },

            checkAnswer: function () {
                const session = this.currentSession;
                const q = session.questions[session.idx];
                const isCorrect = session.selectedOpt === q.c;

                const btns = document.querySelectorAll('[id^="opt-"]');
                btns.forEach(b => b.disabled = true);

                const selBtn = document.getElementById(`opt-${session.selectedOpt}`);
                const corBtn = document.getElementById(`opt-${q.c}`);

                if (isCorrect) {
                    selBtn.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
                    session.score += 10;
                    session.correctCount++;
                } else {
                    selBtn.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
                    corBtn.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
                    session.lives--;
                }
                UI.showFeedback(isCorrect, q.h, 'Game.nextQuestion()');
            },

            nextQuestion: function () {
                const session = this.currentSession;
                session.idx++;

                if (session.idx < session.questions.length && session.lives > 0) {
                    UI.renderGameScreen(session.questions[session.idx], session.totalQuestions, session.idx, session.lives);
                } else {
                    this.finishLevel();
                }
            },

            finishLevel: function () {
                const session = this.currentSession;

                // Salva no hist√≥rico que essas perguntas foram vistas (para n√£o repetir logo)
                State.addToHistory(session.questionIds);

                const percent = (session.correctCount / session.totalQuestions) * 100;
                const passed = percent >= 70;

                // Registra tentativa (sucesso ou falha)
                State.registerAttempt(session.catId, session.levelIdx, passed);

                if (passed) {
                    State.data.progress[`${session.catId}-lvl${session.levelIdx}`] = true;
                    State.data.coins += 20;
                    State.save();
                    UI.showResult(true, session.score, session.totalQuestions, null, 'UI.renderMap()');
                } else {
                    // Verifica bloqueio
                    const status = State.getAttemptStatus(session.catId, session.levelIdx);

                    if (status.locked) {
                        alert(`Voc√™ falhou 2 vezes seguidas. O n√≠vel est√° bloqueado por 24h para voc√™ descansar.`);
                        UI.renderMap();
                    } else {
                        UI.showResult(false, session.score, session.totalQuestions, `Game.retryLevel('${session.catId}', ${session.levelIdx})`, 'UI.renderMap()');
                    }
                }
            },

            retryLevel: function (catId, lvlIdx) {
                const levels = [2, 4, 6, 7]; // BloomMax mapping
                const bloomMax = levels[lvlIdx];
                this.startLevel(catId, lvlIdx, bloomMax);
            }
        };

        window.onload = function () {
            if (State.load()) {
                UI.renderMap();
                document.getElementById('screen-intro').classList.add('hidden-screen');
                document.getElementById('screen-map').classList.remove('hidden-screen');
                document.getElementById('main-header').classList.remove('hidden-screen');
                UI.updateHeader();
            }
        };
    </script>
</body>

</html>