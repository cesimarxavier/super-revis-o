<!DOCTYPE html>
<html lang="pt-BR" data-theme="cupcake">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mestres do Saber</title>

    <meta name="theme-color" content="#65C3C8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">

    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.6.0/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Fredoka', 'sans-serif'] },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                        'float': 'float 4s ease-in-out infinite',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'slide-up': 'slideUp 0.4s ease-out forwards',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        pop: { '0%': { transform: 'scale(0.8)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            },
            daisyui: {
                themes: ["cupcake", "bumblebee", "emerald", "corporate", "synthwave", "retro", "cyberpunk", "valentine", "halloween", "garden", "forest", "aqua", "lofi", "pastel", "fantasy", "wireframe", "black", "luxury", "dracula", "cmyk", "autumn", "business", "acid", "lemonade", "night", "coffee", "winter", "dim", "nord", "sunset"],
            },
        }
    </script>

    <style>
        body {
            background-image: radial-gradient(hsla(var(--bc) / 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 100px;
        }

        .hidden-screen {
            display: none !important;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: hsla(var(--p) / 0.5);
            border-radius: 10px;
        }

        /* Estilo Tabuada */
        .tabuada-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .tabuada-item {
            background: rgba(255, 255, 255, 0.5);
            padding: 8px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="min-h-screen flex flex-col items-center overflow-x-hidden bg-base-200 text-base-content">

    <div id="main-header" class="fixed top-0 z-40 w-full p-2 hidden-screen transition-all duration-300">
        <div
            class="navbar bg-base-100/90 backdrop-blur-md shadow-lg rounded-box max-w-xl mx-auto border-b-4 border-base-300 min-h-[4rem]">
            <div class="flex-1">
                <button class="btn btn-ghost gap-2 normal-case p-1 pr-3" onclick="settings_modal.showModal()">
                    <div class="avatar placeholder">
                        <div
                            class="bg-neutral text-neutral-content rounded-full w-10 ring ring-primary ring-offset-base-100 ring-offset-2">
                            <span class="text-xl" id="header-avatar">üßô‚Äç‚ôÇÔ∏è</span>
                        </div>
                    </div>
                    <div class="flex flex-col items-start leading-none">
                        <span class="text-[10px] opacity-60 uppercase font-bold tracking-wider">Guardi√£o</span>
                        <span class="font-bold text-base truncate max-w-[80px]" id="header-nick">Jogador</span>
                    </div>
                </button>
            </div>

            <div class="flex-none gap-2">
                <div class="badge badge-lg bg-red-100 text-red-600 border-red-200 gap-1 font-black shadow-sm p-3 transition-colors"
                    id="header-hearts-badge">
                    <span id="header-hearts-count">3</span>x ‚ù§Ô∏è
                </div>
                <div class="badge badge-lg badge-primary gap-1 font-bold shadow-sm p-3">
                    ü™ô <span id="header-coins">0</span>
                </div>
                <div class="hidden sm:flex badge badge-lg badge-secondary gap-1 font-bold shadow-sm p-3">
                    üíé <span id="header-gems">0</span>
                </div>
            </div>
        </div>
    </div>

    <main id="game-container" class="w-full max-w-xl flex-grow flex flex-col pt-24 px-4 gap-4">

        <section id="screen-intro" class="hero min-h-[80vh] animate-slide-up">
            <div class="hero-content text-center">
                <div class="max-w-md">
                    <div class="mb-6 relative inline-block">
                        <div class="absolute inset-0 bg-primary blur-3xl opacity-40 rounded-full animate-pulse"></div>
                        <div class="text-9xl animate-float relative z-10">üè∞</div>
                    </div>
                    <h1 class="text-5xl font-black text-primary mb-2 drop-shadow-sm">Mestres<br><span
                            class="text-secondary">do Saber</span></h1>
                    <div class="card w-full bg-base-100 shadow-xl border-b-8 border-base-300">
                        <div class="card-body">
                            <label class="label"><span class="label-text font-bold uppercase text-xs opacity-60">Como
                                    devo te chamar?</span></label>
                            <input type="text" id="input-nick" placeholder="Ex: Super Sofia" maxlength="12"
                                class="input input-bordered input-primary w-full text-center text-xl font-bold mb-4" />
                            <button onclick="Game.startAdventure()"
                                class="btn btn-primary btn-lg w-full shadow-lg border-b-4 border-primary-focus active:border-b-0 active:translate-y-1">Come√ßar
                                Aventura üöÄ</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="screen-map" class="hidden-screen w-full pb-20">
            <div class="text-center mb-6 animate-slide-up">
                <div class="badge badge-accent badge-outline font-bold mb-2">MUNDO 1</div>
                <h2 class="text-3xl font-black">Mapa Mundi</h2>
            </div>
            <div class="grid grid-cols-2 gap-4 animate-slide-up" id="subjects-grid"></div>
        </section>

        <section id="screen-subject" class="hidden-screen w-full pb-20">
            <button onclick="UI.showScreen('screen-map')" class="btn btn-sm btn-ghost mb-4 gap-2">‚¨Ö Voltar ao
                Mapa</button>
            <div id="subject-header"
                class="card bg-base-100 shadow-xl mb-6 border-b-4 border-base-300 text-center animate-slide-up"></div>
            <div class="flex flex-col gap-4 animate-slide-up" style="animation-delay: 0.1s" id="categories-list"></div>
        </section>

        <section id="screen-game" class="hidden-screen w-full pb-32">
            <div class="flex items-center gap-2 mb-6 bg-base-100 p-2 rounded-2xl shadow-sm border border-base-200">

                <button onclick="Game.exitGame()"
                    class="btn btn-sm btn-error btn-outline bg-red-50 hover:bg-red-100 border-red-200 text-red-600 gap-1 flex-none">
                    ‚úï <span class="hidden sm:inline">Sair</span>
                </button>

                <div id="game-tools-container"></div>

                <div class="flex-grow flex flex-col justify-center px-2">
                    <progress class="progress progress-primary w-full h-3 transition-all duration-500" value="0"
                        max="100" id="game-progress"></progress>
                </div>

                <div class="badge badge-lg badge-neutral font-bold uppercase tracking-widest flex-none text-xs sm:text-sm"
                    id="game-level-tag">N√çVEL 1</div>
            </div>

            <div class="card w-full bg-base-100 shadow-xl border-b-8 border-base-300 animate-pop">
                <div class="card-body items-center text-center relative overflow-hidden">
                    <div class="absolute -top-4 -right-4 text-8xl opacity-5 rotate-12 select-none">‚ùì</div>
                    <h2 class="card-title text-2xl md:text-3xl font-black mb-6 leading-snug z-10 flex flex-col items-center gap-4 w-full"
                        id="game-question">...</h2>

                    <div class="w-full grid gap-3 z-10" id="game-options"></div>
                </div>
            </div>
        </section>

        <section id="screen-result" class="hidden-screen w-full flex-grow flex items-center justify-center pb-20">
            <div id="result-container" class="w-full"></div>
        </section>
    </main>

    <dialog id="tabuada_modal" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box bg-white relative">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2"
                onclick="tabuada_modal.close()">‚úï</button>
            <h3 class="font-black text-2xl text-center text-primary mb-4">üî¢ Tabuada M√°gica</h3>

            <div class="flex flex-wrap gap-2 justify-center mb-6" id="tabuada-selector"></div>

            <div id="tabuada-display" class="bg-base-200 rounded-2xl p-4 hidden">
                <h4 class="text-center font-bold text-xl text-secondary mb-3" id="tabuada-current-title">Tabuada do 2
                </h4>
                <div class="tabuada-grid text-lg text-base-content/80" id="tabuada-content"></div>
            </div>

            <p class="text-center text-xs text-gray-400 mt-4">Toque em um n√∫mero para ver!</p>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <dialog id="settings_modal" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4 text-center">Configura√ß√µes</h3>
            <div class="form-control w-full mb-6">
                <label class="label"><span class="label-text font-bold">Seu Nome</span></label>
                <div class="join w-full">
                    <input type="text" id="settings-nick"
                        class="input input-bordered input-primary join-item w-full font-bold" />
                    <button class="btn btn-primary join-item" onclick="Game.updateSettings()">Salvar</button>
                </div>
            </div>
            <label class="label"><span class="label-text font-bold">Estilo Visual</span></label>
            <div class="grid grid-cols-3 gap-2 mb-6">
                <button class="btn btn-outline btn-xs h-auto py-2 flex flex-col gap-1"
                    onclick="UI.changeTheme('cupcake')">
                    <span class="w-4 h-4 rounded-full bg-[#65c3c8]"></span>Cupcake
                </button>
                <button class="btn btn-outline btn-xs h-auto py-2 flex flex-col gap-1"
                    onclick="UI.changeTheme('cyberpunk')">
                    <span class="w-4 h-4 rounded-full bg-[#e0a82e]"></span>Abelha
                </button>
                <button class="btn btn-outline btn-xs h-auto py-2 flex flex-col gap-1"
                    onclick="UI.changeTheme('forest')">
                    <span class="w-4 h-4 rounded-full bg-[#66cc8a]"></span>Esmeralda
                </button>
                <button class="btn btn-outline btn-xs h-auto py-2 flex flex-col gap-1"
                    onclick="UI.changeTheme('fantasy')">
                    <span class="w-4 h-4 rounded-full bg-[#6e0b75]"></span>Fantasia
                </button>
                <button class="btn btn-outline btn-xs h-auto py-2 flex flex-col gap-1"
                    onclick="UI.changeTheme('dracula')">
                    <span class="w-4 h-4 rounded-full bg-[#ff79c6]"></span>Noite
                </button>
                <button class="btn btn-outline btn-xs h-auto py-2 flex flex-col gap-1"
                    onclick="UI.changeTheme('retro')">
                    <span class="w-4 h-4 rounded-full bg-[#ef9995]"></span>Retro
                </button>
                <button class="btn btn-outline btn-xs h-auto py-2 flex flex-col gap-1"
                    onclick="UI.changeTheme('valentine')">
                    <span class="w-4 h-4 rounded-full bg-[#f3bdf4]"></span>Rosinha
                </button>
                <button class="btn btn-outline btn-xs h-auto py-2 flex flex-col gap-1"
                    onclick="UI.changeTheme('caramellatte')">
                    <span class="w-4 h-4 rounded-full bg-[#cebf87]"></span>Caramelo
                </button>
                <button class="btn btn-outline btn-xs h-auto py-2 flex flex-col gap-1" onclick="UI.changeTheme('nord')">
                    <span class="w-4 h-4 rounded-full bg-[#676663]"></span>Cinza
                </button>
            </div>
            <div class="modal-action justify-center">
                <form method="dialog"><button class="btn btn-ghost">Fechar</button></form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <dialog id="prep_modal" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box p-0 relative overflow-hidden bg-base-100">
            <div class="bg-primary text-primary-content p-6 text-center">
                <div class="text-6xl mb-2 animate-bounce" id="prep-icon">üìú</div>
                <h3 class="font-black text-2xl uppercase" id="prep-title">T√≠tulo</h3>
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2 text-white"
                    onclick="prep_modal.close()">‚úï</button>
            </div>
            <div class="p-6 max-h-[60vh] overflow-y-auto custom-scroll">
                <div class="prose prose-lg leading-snug text-base-content/80 text-center" id="prep-content"></div>
                <div class="alert alert-warning mt-6 shadow-sm">
                    <div class="text-2xl">üéÅ</div>
                    <div>
                        <h3 class="font-bold text-xs uppercase">Recompensa</h3>
                        <div class="text-sm font-bold" id="prep-reward-text">Skin: Mago</div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-base-200 border-t border-base-300">
                <button onclick="Game.finishPrep()"
                    class="btn btn-success btn-lg w-full shadow-lg border-b-4 border-success-content/20 active:border-b-0 active:translate-y-1">Estou
                    Pronto! ‚öîÔ∏è</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <div id="footer-action"
        class="fixed bottom-0 left-0 w-full bg-base-100/90 backdrop-blur-md border-t border-base-200 p-4 z-40 hidden-screen transition-all duration-300">
        <div class="max-w-xl mx-auto" id="footer-content"></div>
    </div>

    <script src="database.js"></script>
    <script>
        const CURRENT_VERSION = 'mestres_save_v7';
        const LEGACY_VERSIONS = ['mestres_save_v6', 'mestres_save_v5'];

        const State = {
            data: { nick: "", coins: 0, gems: 0, skins: ["üßô‚Äç‚ôÇÔ∏è"], currentSkin: "üßô‚Äç‚ôÇÔ∏è", progress: {}, attempts: {}, history: [], theme: "cupcake" },
            load: function () {
                let saved = localStorage.getItem(CURRENT_VERSION);
                if (!saved) {
                    for (const oldKey of LEGACY_VERSIONS) {
                        const legacy = localStorage.getItem(oldKey);
                        if (legacy) { saved = legacy; break; }
                    }
                }
                if (saved) {
                    try {
                        this.data = JSON.parse(saved);
                        if (!this.data.history) this.data.history = [];
                        if (!this.data.theme) this.data.theme = "cupcake";
                        return true;
                    } catch (e) { return false; }
                }
                return false;
            },
            save: function () { localStorage.setItem(CURRENT_VERSION, JSON.stringify(this.data)); UI.updateHeader(); },
            addToHistory: function (ids) { ids.forEach(id => { if (!this.data.history.includes(id)) this.data.history.push(id); }); this.save(); },
            cleanHistoryForPool: function (poolIds) { this.data.history = this.data.history.filter(id => !poolIds.includes(id)); this.save(); },
            unlockSkin: function (skin) { if (!this.data.skins.includes(skin)) { this.data.skins.push(skin); this.data.currentSkin = skin; this.save(); alert(`Nova Skin: ${skin}`); } },
            checkLevelUnlock: function (catId, lvlIdx) { if (lvlIdx === 0) return true; return this.data.progress[`${catId}-lvl${lvlIdx - 1}`] === true; }
        };

        const UI = {
            screens: ['screen-intro', 'screen-map', 'screen-subject', 'screen-game', 'screen-result'],

            showScreen: function (id) {
                this.screens.forEach(s => document.getElementById(s).classList.add('hidden-screen'));
                const target = document.getElementById(id);
                if (target) { target.classList.remove('hidden-screen'); target.classList.add('animate-slide-up'); }
                const header = document.getElementById('main-header');
                const footer = document.getElementById('footer-action');
                if (id === 'screen-intro') { if (header) header.classList.add('hidden-screen'); if (footer) footer.classList.add('hidden-screen'); }
                else { if (header) header.classList.remove('hidden-screen'); this.updateHeader(); }
            },
            updateHeader: function () {
                document.getElementById('header-nick').innerText = State.data.nick;
                document.getElementById('header-avatar').innerText = State.data.currentSkin;
                document.getElementById('header-coins').innerText = State.data.coins;
                document.getElementById('header-gems').innerText = State.data.gems;
                document.documentElement.setAttribute('data-theme', State.data.theme);

                // Vida
                const heartBadge = document.getElementById('header-hearts-badge');
                const heartCount = document.getElementById('header-hearts-count');
                const livesToShow = Game.currentSession ? Game.currentSession.lives : 3;
                heartCount.innerText = livesToShow;
                if (livesToShow === 0) heartBadge.className = "badge badge-lg bg-gray-200 text-gray-400 border-gray-300 gap-1 font-black shadow-sm p-3 transition-colors";
                else heartBadge.className = "badge badge-lg bg-red-100 text-red-600 border-red-200 gap-1 font-black shadow-sm p-3 transition-colors";
            },
            changeTheme: function (themeName) { document.documentElement.setAttribute('data-theme', themeName); State.data.theme = themeName; State.save(); },
            initTabuada: function () {
                const selector = document.getElementById('tabuada-selector');
                selector.innerHTML = '';
                for (let i = 1; i <= 10; i++) {
                    selector.innerHTML += `<button onclick="UI.showTabuadaTable(${i})" class="btn btn-circle btn-outline btn-primary font-bold text-lg hover:scale-110 transition-transform">${i}</button>`;
                }
            },
            showTabuadaTable: function (num) {
                const display = document.getElementById('tabuada-display');
                document.getElementById('tabuada-current-title').innerText = `Tabuada do ${num}`;
                const content = document.getElementById('tabuada-content');
                display.classList.remove('hidden'); display.classList.add('animate-pop');
                content.innerHTML = '';
                for (let i = 1; i <= 10; i++) content.innerHTML += `<div class="tabuada-item">${num} x ${i} = <span class="text-primary">${num * i}</span></div>`;
            },
            renderMap: function () {
                const grid = document.getElementById('subjects-grid');
                if (!grid) return; grid.innerHTML = '';
                if (typeof DB === 'undefined') return console.error("Database Error");
                DB.subjects.forEach(sub => {
                    grid.innerHTML += `
                    <div onclick="Game.openSubject('${sub.id}')" 
                        class="card bg-base-100 shadow-md hover:shadow-xl transition-all duration-300 cursor-pointer border-b-4 border-base-300 active:scale-95 group">
                        <div class="card-body p-4 items-center text-center relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-2 opacity-10 text-6xl group-hover:scale-110 transition-transform select-none">${sub.icon}</div>
                            <div class="w-14 h-14 rounded-2xl flex items-center justify-center text-3xl text-white shadow-lg mb-2 ${sub.color}">${sub.icon}</div>
                            <h3 class="card-title text-base leading-tight">${sub.name}</h3>
                            <div class="badge badge-ghost badge-sm font-bold mt-1">${sub.categories.length} AVENTURAS</div>
                        </div>
                    </div>`;
                });
                this.showScreen('screen-map');
            },
            renderSubject: function (subId) {
                const sub = DB.subjects.find(s => s.id === subId);
                const container = document.getElementById('categories-list');
                const header = document.getElementById('subject-header');

                let tabuadaBtn = sub.id === 'mat' ? `<button onclick="document.getElementById('tabuada_modal').showModal()" class="btn btn-circle btn-primary btn-outline absolute right-4 top-4 shadow-md bg-white animate-bounce-slow">üî¢</button>` : '';

                header.innerHTML = `
                    <div class="card-body items-center text-center relative">
                        ${tabuadaBtn}
                        <div class="text-7xl animate-float filter drop-shadow-md">${sub.icon}</div>
                        <h2 class="card-title text-3xl font-black">${sub.name}</h2>
                        <p class="opacity-70">Complete os desafios!</p>
                    </div>`;
                container.innerHTML = '';
                sub.categories.forEach(cat => {
                    let levelsHTML = '';
                    const levels = [
                        { name: "F√°cil", class: "btn-info", icon: "üê£", bloomMax: 2 },
                        { name: "M√©dio", class: "btn-success", icon: "‚öîÔ∏è", bloomMax: 4 },
                        { name: "Tit√£", class: "btn-secondary", icon: "üëπ", bloomMax: 6 },
                        { name: "Mestre", class: "btn-warning", icon: "üëë", bloomMax: 7 }
                    ];
                    levels.forEach((lvl, idx) => {
                        const isUnlocked = State.checkLevelUnlock(cat.id, idx);
                        const isDone = State.data.progress[`${cat.id}-lvl${idx}`];
                        let btnClass = isUnlocked ? `btn ${lvl.class} border-b-4` : "btn btn-disabled";
                        if (isDone) btnClass = "btn btn-outline border-b-4 btn-success";
                        const icon = isDone ? "‚úÖ" : (isUnlocked ? lvl.icon : "üîí");
                        const action = isUnlocked ? `Game.startLevel('${cat.id}', ${idx}, ${lvl.bloomMax}, '${lvl.name}')` : '';
                        levelsHTML += `<button onclick="${action}" class="join-item flex-1 ${btnClass} flex-col gap-0 h-auto py-2"><span class="text-xl leading-none">${icon}</span><span class="text-[10px] uppercase font-bold">${lvl.name}</span></button>`;
                    });
                    container.innerHTML += `<div class="card bg-base-100 shadow-sm border border-base-200"><div class="card-body p-4"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg flex items-center gap-2"><span class="w-2 h-6 rounded bg-primary"></span>${cat.name}</h3><button onclick="Game.openPrep('${cat.id}')" class="btn btn-sm btn-ghost gap-2 text-warning">üìú <span class="hidden sm:inline">Preparar</span></button></div><div class="join w-full grid grid-cols-4 gap-1">${levelsHTML}</div></div></div>`;
                });
                this.showScreen('screen-subject');
            },
            openPrepModal: function (content) {
                document.getElementById('prep-icon').innerText = content.skin;
                document.getElementById('prep-title').innerHTML = content.title;
                document.getElementById('prep-content').innerHTML = content.content;
                document.getElementById('prep-reward-text').innerText = `Skin: ${content.skin}`;
                document.getElementById('prep_modal').showModal();
            },
            closePrep: function () { document.getElementById('prep_modal').close(); },
            renderGameScreen: function (q, total, current, lives, levelName) {
                this.showScreen('screen-game');
                const pct = ((current) / total) * 100;
                document.getElementById('game-progress').value = pct;
                document.getElementById('game-level-tag').innerText = levelName;
                this.updateHeader();

                const toolsContainer = document.getElementById('game-tools-container');
                if (Game.currentSession && Game.currentSession.subjectId === 'mat') {
                    toolsContainer.innerHTML = `<button onclick="document.getElementById('tabuada_modal').showModal()" class="btn btn-sm btn-circle btn-primary btn-outline" title="Tabuada">üî¢</button>`;
                } else {
                    toolsContainer.innerHTML = '';
                }

                document.getElementById('game-question').innerHTML = q.q.replace(/\*\*(.*?)\*\*/g, '<span class="text-primary border-b-2 border-primary border-dashed">$1</span>').replace(/______/g, '<span class="inline-block w-16 border-b-2 border-base-content/50"></span>');
                const optsContainer = document.getElementById('game-options');
                optsContainer.innerHTML = '';
                q.opts.forEach((opt, idx) => {
                    optsContainer.innerHTML += `<button onclick="Game.selectOption(${idx})" id="opt-${idx}" class="btn btn-outline btn-lg w-full h-auto py-4 justify-start text-left normal-case border-b-4 hover:border-b-4"><span class="badge badge-ghost mr-2">${String.fromCharCode(65 + idx)}</span>${opt}</button>`;
                });
                const footer = document.getElementById('footer-action');
                footer.classList.remove('hidden-screen');
                footer.innerHTML = `<button class="btn btn-disabled btn-lg w-full rounded-2xl">Escolha uma resposta</button>`;
            },
            showFeedback: function (isCorrect, hint, nextFn) {
                const footer = document.getElementById('footer-action');
                const bgClass = isCorrect ? 'bg-success text-success-content' : 'bg-error text-error-content';
                footer.innerHTML = `<div class="w-full max-w-xl mx-auto animate-slide-up"><div class="alert ${bgClass} shadow-lg mb-3 flex-row items-start"><span class="text-3xl">${isCorrect ? 'üéâ' : 'ü§î'}</span><div><h3 class="font-bold uppercase text-xs tracking-wider">${isCorrect ? 'Mandou Bem!' : 'Ops, corre√ß√£o:'}</h3><div class="text-sm font-medium opacity-90">${hint}</div></div></div><button onclick="${nextFn}" class="btn btn-lg w-full ${bgClass} border-b-4 border-black/20 hover:border-black/20">${isCorrect ? 'CONTINUAR' : 'ENTENDI'}</button></div>`;
            },
            showResult: function (isVictory, score, totalQuestions, nextLevelFn, retryFn, subjectFn) {
                const container = document.getElementById('result-container');
                document.getElementById('footer-action').classList.add('hidden-screen');
                const percentage = Math.round((score / (totalQuestions * 10)) * 100);
                if (isVictory) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                container.innerHTML = `
                <div class="hero min-h-[60vh] animate-pop">
                    <div class="hero-content text-center">
                        <div class="max-w-md">
                            <div class="text-9xl mb-4 animate-bounce">${isVictory ? 'üèÜ' : 'üê¢'}</div>
                            <h1 class="text-4xl font-black mb-2">${isVictory ? 'Vit√≥ria √âpica!' : 'Quase l√°!'}</h1>
                            <p class="py-2 opacity-70 mb-6">${isVictory ? 'Voc√™ provou ser um Mestre!' : 'Voc√™ precisa de 70% para passar.'}</p>
                            <div class="stats shadow w-full mb-8 bg-base-100 border border-base-200"><div class="stat place-items-center"><div class="stat-title uppercase font-bold text-xs">Sua Nota</div><div class="stat-value ${isVictory ? 'text-primary' : 'text-error'}">${percentage}%</div><div class="stat-desc font-bold">M√≠nimo: 70%</div></div>${isVictory ? `<div class="stat place-items-center"><div class="stat-title uppercase font-bold text-xs">Recompensa</div><div class="stat-value text-warning">20</div><div class="stat-desc font-bold text-warning">Moedas</div></div>` : ''}</div>
                            <div class="flex flex-col gap-3">
                                ${isVictory && nextLevelFn ? `<button onclick="${nextLevelFn}" class="btn btn-primary btn-lg shadow-lg border-b-4 border-primary-focus">Pr√≥ximo N√≠vel ‚û°Ô∏è</button>` : ''}
                                <button onclick="${retryFn}" class="btn btn-secondary btn-outline btn-lg">${isVictory ? 'Jogar Novamente' : 'Tentar Novamente'}</button>
                                <button onclick="${subjectFn}" class="btn btn-ghost">Voltar para o Assunto</button>
                            </div>
                        </div>
                    </div>
                </div>`;
                this.showScreen('screen-result');
            }
        };

        const Game = {
            currentSession: null,
            exitGame: function () {
                if (confirm("Sair agora perde o progresso! üõ°Ô∏è")) {
                    const subjectId = this.currentSession ? this.currentSession.subjectId : 'pt';
                    this.currentSession = null;
                    UI.renderSubject(subjectId);
                    UI.updateHeader();
                }
            },
            startAdventure: function () { const n = document.getElementById('input-nick').value; if (n.length < 3) return alert("Nome curto!"); State.data.nick = n; State.save(); UI.renderMap(); },
            updateSettings: function () { State.data.nick = document.getElementById('settings-nick').value; State.save(); document.getElementById('settings_modal').close(); },
            openSubject: function (id) { UI.renderSubject(id); },
            openPrep: function (catId) {
                let c = null; DB.subjects.forEach(s => { const f = s.categories.find(k => k.id === catId); if (f) c = f; });
                this.tempSkin = c.prep.skin; UI.openPrepModal(c.prep);
            },
            finishPrep: function () { State.unlockSkin(this.tempSkin); State.data.coins += 10; State.save(); document.getElementById('prep_modal').close(); try { confetti({ particleCount: 50, spread: 50 }); } catch (e) { } },
            startLevel: function (catId, levelIdx, bloomMax, levelName) {
                let category = null; let subjectId = null;
                DB.subjects.forEach(s => { const c = s.categories.find(k => k.id === catId); if (c) { category = c; subjectId = s.id; } });
                if (!levelName) levelName = ["F√°cil", "M√©dio", "Tit√£", "Mestre"][levelIdx];
                let minBloom = bloomMax - 1; if (levelIdx === 0) minBloom = 1;
                const pool = category.pool.filter(q => q.bloom >= minBloom && q.bloom <= bloomMax);
                let fresh = pool.filter(q => !State.data.history.includes(q.id));
                if (fresh.length < 5) { State.cleanHistoryForPool(pool.map(q => q.id)); fresh = pool; }
                const selected = fresh.sort(() => 0.5 - Math.random()).slice(0, 5);
                if (selected.length === 0) return alert("Erro: Sem quest√µes.");
                this.currentSession = { subjectId, catId, levelIdx, questions: selected, questionIds: selected.map(q => q.id), idx: 0, lives: 3, score: 0, total: 5, correct: 0, levelName };
                UI.renderGameScreen(selected[0], 5, 0, 3, levelName);
            },
            selectOption: function (optIdx) {
                const btns = document.querySelectorAll('[id^="opt-"]');
                btns.forEach(b => { b.classList.remove('btn-active', 'btn-primary'); b.classList.add('btn-outline'); });
                const sel = document.getElementById(`opt-${optIdx}`);
                sel.classList.remove('btn-outline'); sel.classList.add('btn-primary', 'border-b-4');
                this.currentSession.selectedOpt = optIdx;
                const footer = document.getElementById('footer-action');
                footer.innerHTML = `<button onclick="Game.checkAnswer()" class="btn btn-primary btn-lg w-full rounded-2xl shadow-lg border-b-4 border-primary-focus">CONFIRMAR</button>`;
            },
            checkAnswer: function () {
                const s = this.currentSession; const q = s.questions[s.idx]; const isCorrect = s.selectedOpt === q.c;
                const btns = document.querySelectorAll('[id^="opt-"]'); btns.forEach(b => b.disabled = true);
                const selBtn = document.getElementById(`opt-${s.selectedOpt}`);
                if (isCorrect) { selBtn.classList.remove('btn-primary'); selBtn.classList.add('btn-success', 'text-white'); s.score += 10; s.correct++; }
                else { selBtn.classList.remove('btn-primary'); selBtn.classList.add('btn-error', 'text-white'); s.lives--; UI.updateHeader(); }
                UI.showFeedback(isCorrect, q.h, 'Game.nextQuestion()');
            },
            nextQuestion: function () {
                const s = this.currentSession;
                if (s.lives <= 0) { this.finishLevel(); return; }
                s.idx++;
                if (s.idx < s.questions.length) UI.renderGameScreen(s.questions[s.idx], s.total, s.idx, s.lives, s.levelName);
                else this.finishLevel();
            },
            finishLevel: function () {
                const s = this.currentSession;
                State.addToHistory(s.questionIds);
                const passed = (s.correct / s.total) * 100 >= 70;

                const retryFn = `Game.startLevel('${s.catId}', ${s.levelIdx}, ${[2, 4, 6, 7][s.levelIdx]}, '${s.levelName}')`;
                const subjectFn = `UI.renderSubject('${s.subjectId}')`;
                let nextLevelFn = null;
                if (passed && s.levelIdx < 3) {
                    const nextIdx = s.levelIdx + 1;
                    const nextNames = ["F√°cil", "M√©dio", "Tit√£", "Mestre"];
                    const nextBlooms = [2, 4, 6, 7];
                    nextLevelFn = `Game.startLevel('${s.catId}', ${nextIdx}, ${nextBlooms[nextIdx]}, '${nextNames[nextIdx]}')`;
                }
                this.currentSession = null; UI.updateHeader();
                if (passed) {
                    State.data.progress[`${s.catId}-lvl${s.levelIdx}`] = true;
                    State.data.coins += 20; State.save();
                    UI.showResult(true, s.score, s.total, nextLevelFn, retryFn, subjectFn);
                } else {
                    UI.showResult(false, s.score, s.total, null, retryFn, subjectFn);
                }
            }
        };

        window.onload = function () {
            UI.initTabuada();
            if (State.load()) {
                UI.renderMap();
                document.getElementById('screen-intro').classList.add('hidden-screen');
            }
            UI.updateHeader();
        };
    </script>
</body>

</html>