<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lendas do Saber - Modo Drag√£o</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4ECDC4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Lendas do Saber">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Fredoka', 'sans-serif'] },
                    colors: {
                        'school-red': '#FF6B6B',
                        'school-blue': '#4ECDC4',
                        'school-yellow': '#FFE66D',
                        'school-green': '#1A535C',
                        'dragon-gold': '#FFD700',
                        'dragon-dark': '#2D3748',
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 3s ease-in-out infinite',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F0F4F8;
            background-image: radial-gradient(#CBD5E1 2px, transparent 2px);
            background-size: 30px 30px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-3d {
            transition: transform 0.1s;
            border-bottom-width: 5px;
        }

        .btn-3d:active {
            transform: translateY(5px);
            border-bottom-width: 0px;
        }

        .fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="font-sans text-gray-700 min-h-screen flex flex-col items-center">

    <header class="w-full bg-white p-4 shadow-lg border-b-4 border-blue-200 sticky top-0 z-50">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div
                class="flex items-center gap-3 bg-blue-50 px-3 py-2 rounded-2xl border-2 border-blue-100 cursor-pointer">
                <div class="text-3xl animate-float" id="char-icon">ü•ö</div>
                <div class="leading-tight hidden md:block">
                    <p class="text-xs font-bold text-gray-400 uppercase">Eu sou um</p>
                    <p class="text-sm font-bold text-school-green" id="char-name">Ovo Curioso</p>
                </div>
            </div>
            <div
                class="bg-school-yellow px-4 py-2 rounded-2xl border-b-4 border-yellow-500 shadow-sm flex items-center gap-2">
                <span class="text-xl">‚≠ê</span>
                <span id="global-score" class="font-bold text-xl text-yellow-900">0</span>
            </div>
        </div>
    </header>

    <main id="app" class="w-full max-w-3xl p-4 md:p-6 flex-grow flex flex-col items-center justify-start pb-24"></main>

    <script>
        // --- CONTE√öDO PEDAG√ìGICO COMPLETO (7 FASES) ---
        const quizData = [
            {
                id: 1, title: "Pronomes", medal: "Detetive", icon: "üéí", color: "bg-blue-400",
                description: "Quem √© o dono?",
                study: {
                    title: "O que s√£o Pronomes?",
                    content: "Pronomes s√£o palavras que substituem nomes ou mostram de quem s√£o as coisas.",
                    cards: [
                        { emoji: "üôã‚Äç‚ôÇÔ∏è", text: "POSSESSIVOS: Indicam Dono. Ex: Meu, Teu, Nosso." },
                        { emoji: "üëâ", text: "DEMONSTRATIVOS: Mostram Lugar. Ex: Este (perto), Aquele (longe)." }
                    ]
                },
                questions: [
                    { level: "N√≠vel 1", q: "A palavra **Minha** indica:", options: ["Posse (dono)", "Lugar", "Cor", "Tamanho"], correct: 0, explanation: "Minha indica que pertence a mim!" },
                    { level: "N√≠vel 1", q: "Qual palavra usamos para **apontar** algo longe?", options: ["Meu", "Teu", "Aquele", "N√≥s"], correct: 2, explanation: "Aquele serve para mostrar algo distante." },
                    { level: "N√≠vel 2", q: "O menino segura a bola e diz: '______ bola √© nova'.", options: ["Aquela", "Esta", "Essa", "Tua"], correct: 1, explanation: "Se est√° na m√£o dele, √© ESTA." },
                    { level: "N√≠vel 2", q: "N√≥s temos um cachorro. Ele √© ______.", options: ["Meu", "Teu", "Nosso", "Ele"], correct: 2, explanation: "Se pertence a n√≥s, √© Nosso." },
                    { level: "N√≠vel 3", q: "Complete corretamente: 'Tu perdeste o ______ caderno?'", options: ["Meu", "Seu", "Nosso", "Teu"], correct: 3, explanation: "Tu combina com Teu." }
                ]
            },
            {
                id: 2, title: "S e Z", medal: "Encantador", icon: "üêç", color: "bg-school-yellow",
                description: "O som que engana!",
                study: {
                    title: "Regra do S com som de Z",
                    content: "O S √© muito esperto! Quando ele est√° sozinho no meio de duas vogais, ele imita o som do Z.",
                    cards: [
                        { emoji: "üè†", text: "CA-S-A (S entre dois A)" },
                        { emoji: "üë∏", text: "PRIN-CE-S-A (S entre E e A)" }
                    ]
                },
                questions: [
                    { level: "N√≠vel 1", q: "Qual a escrita correta?", options: ["Caza", "Casa", "Cassa", "Kasa"], correct: 1, explanation: "S entre vogais tem som de Z." },
                    { level: "N√≠vel 1", q: "Princesa se escreve com...", options: ["Z", "S", "√á", "SS"], correct: 1, explanation: "T√≠tulos femininos usam S (Duquesa, Princesa)." },
                    { level: "N√≠vel 2", q: "Mesa ou Meza?", options: ["Meza", "Messa", "Mesa", "Me√ßa"], correct: 2, explanation: "Mesa se escreve com S." },
                    { level: "N√≠vel 3", q: "O som de Z em 'Raposa' √© feito com qual letra?", options: ["Z", "S", "X", "J"], correct: 1, explanation: "Raposa se escreve com S!" }
                ]
            },
            {
                id: 3, title: "Verbos", medal: "Atleta", icon: "üèÉ", color: "bg-school-green",
                description: "Luz, c√¢mera, a√ß√£o!",
                study: {
                    title: "Verbo √© A√ß√£o",
                    content: "Verbos s√£o palavras que indicam o que algu√©m est√° fazendo, sentindo ou como est√° a natureza.",
                    cards: [
                        { emoji: "üèÉ", text: "A√ß√£o: Correr, Pular" },
                        { emoji: "‚õàÔ∏è", text: "Natureza: Chover, Ventar" }
                    ]
                },
                questions: [
                    { level: "N√≠vel 1", q: "Qual palavra √© uma a√ß√£o?", options: ["Mesa", "Pular", "Azul", "Gato"], correct: 1, explanation: "Pular √© algo que se faz!" },
                    { level: "N√≠vel 1", q: "'O gato dormiu'. O verbo √©:", options: ["O", "Gato", "Dormiu", "Fofinho"], correct: 2, explanation: "Dormiu √© o que o gato fez." },
                    { level: "N√≠vel 2", q: "Complete: Amanh√£ eu ______ bolo.", options: ["Comi", "Como", "Comerei", "Comia"], correct: 2, explanation: "Amanh√£ √© futuro: Comerei." },
                    { level: "N√≠vel 3", q: "Qual N√ÉO √© verbo?", options: ["Cantar", "Falar", "Bonito", "Dan√ßar"], correct: 2, explanation: "Bonito √© uma qualidade, n√£o uma a√ß√£o." }
                ]
            },
            {
                id: 4, title: "LH e LI", medal: "Coelho", icon: "üêá", color: "bg-purple-400",
                description: "Sons parecidos",
                study: {
                    title: "LH ou LI?",
                    content: "O som √© parecido, mas a escrita √© diferente. O LH tem som de 'lha, lhe, lhi', mais molhado.",
                    cards: [
                        { emoji: "ü•Ñ", text: "Co-LHER (LH)" },
                        { emoji: "üë™", text: "Fa-m√≠-LIA (LI)" }
                    ]
                },
                questions: [
                    { level: "N√≠vel 1", q: "Orelhudo vem de Orelha. Escreve-se com:", options: ["LI", "LH", "L", "LY"], correct: 1, explanation: "Orelha √© com LH." },
                    { level: "N√≠vel 1", q: "Qual est√° certo?", options: ["Familha", "Fam√≠lia", "Famiia", "Familla"], correct: 1, explanation: "Fam√≠lia √© com LI." },
                    { level: "N√≠vel 2", q: "O coelho comeu a...", options: ["Folhia", "Folha", "Folia", "Folla"], correct: 1, explanation: "Folha √© com LH." },
                    { level: "N√≠vel 3", q: "Sand√°...a?", options: ["Sand√°lia", "Sand√°lha", "Sandala", "Sandaia"], correct: 0, explanation: "Sand√°lia √© com LI." }
                ]
            },
            {
                id: 5, title: "Tempos", medal: "Viajante", icon: "‚è∞", color: "bg-school-red",
                description: "Passado e Futuro",
                study: {
                    title: "A M√°quina do Tempo",
                    content: "Os verbos mudam para mostrar quando a coisa aconteceu.",
                    cards: [
                        { emoji: "üîô", text: "Passado: J√° aconteceu (Eu comi)" },
                        { emoji: "üîú", text: "Futuro: Vai acontecer (Eu comerei)" }
                    ]
                },
                questions: [
                    { level: "N√≠vel 1", q: "Ontem eu ______.", options: ["Brinco", "Brincarei", "Brinquei", "Brinca"], correct: 2, explanation: "Ontem j√° passou: Brinquei." },
                    { level: "N√≠vel 1", q: "Amanh√£ n√≥s ______.", options: ["Vamos", "Fomos", "Est√°vamos", "Era"], correct: 0, explanation: "Amanh√£ √© futuro: Vamos." },
                    { level: "N√≠vel 2", q: "'Ele estudou'. Isso √©:", options: ["Passado", "Presente", "Futuro", "Nenhum"], correct: 0, explanation: "Estudou, j√° acabou." },
                    { level: "N√≠vel 3", q: "Transforme 'Eu corro' para o futuro:", options: ["Eu corri", "Eu correria", "Eu correrei", "Eu corria"], correct: 2, explanation: "Futuro certo: Correrei." }
                ]
            },
            {
                id: 6, title: "Sujeito", medal: "Investigador", icon: "üîç", color: "bg-teal-400",
                description: "Quem fez isso?",
                study: {
                    title: "Quem √© o Sujeito?",
                    content: "Sujeito √© a pessoa, animal ou coisa de quem estamos falando na frase.",
                    cards: [
                        { emoji: "üê∂", text: "'O c√£o latiu'. (Quem latiu? O C√£o!)" },
                        { emoji: "üëë", text: "'A rainha chegou'. (Quem chegou? A Rainha!)" }
                    ]
                },
                questions: [
                    { level: "N√≠vel 1", q: "'O beb√™ chorou'. Quem √© o sujeito?", options: ["Chorou", "O beb√™", "Ningu√©m", "O tempo"], correct: 1, explanation: "O beb√™ √© quem chorou." },
                    { level: "N√≠vel 1", q: "'N√≥s gostamos de pizza'. Sujeito:", options: ["Pizza", "Gostamos", "N√≥s", "De"], correct: 2, explanation: "N√≥s somos quem gosta." },
                    { level: "N√≠vel 2", q: "'A linda flor nasceu'. O sujeito √©:", options: ["Nasceu", "Flor", "A linda flor", "Linda"], correct: 2, explanation: "O sujeito √© tudo: A linda flor." },
                    { level: "N√≠vel 3", q: "Quem pratica a a√ß√£o na frase?", options: ["Verbo", "Adjetivo", "Sujeito", "Ponto"], correct: 2, explanation: "O sujeito pratica a a√ß√£o." }
                ]
            },
            {
                id: 7, title: "Cedilha", medal: "Palha√ßo", icon: "üé™", color: "bg-pink-400",
                description: "Regras do √á",
                study: {
                    title: "O Segredo do √á",
                    content: "A cedilha (o rabinho no C) s√≥ aparece antes de A, O, U para ter som de S.",
                    cards: [
                        { emoji: "üö´", text: "NUNCA come√ßa palavra com √á" },
                        { emoji: "‚ù§", text: "Cora√ß√£o, Pa√ßoca, A√ß√∫car" }
                    ]
                },
                questions: [
                    { level: "N√≠vel 1", q: "Podemos come√ßar palavra com √á?", options: ["Sim", "N√£o", "√Äs vezes", "Sempre"], correct: 1, explanation: "Nunca se come√ßa com √á!" },
                    { level: "N√≠vel 1", q: "Cora...√£o?", options: ["√ß√£o", "s√£o", "ss√£o", "c√£o"], correct: 0, explanation: "Cora√ß√£o √© com √á." },
                    { level: "N√≠vel 2", q: "Antes de quais letras usamos √á?", options: ["E e I", "A, O, U", "Todas", "Nenhuma"], correct: 1, explanation: "S√≥ antes de A, O, U." },
                    { level: "N√≠vel 3", q: "Qual est√° errada?", options: ["√áapato", "Carro√ßa", "Mo√ßa", "Cabe√ßa"], correct: 0, explanation: "Sapato √© com S. N√£o come√ßa com √á!" }
                ]
            }
        ];

        // --- QUEST√ïES DO MODO DRAG√ÉO (ENDGAME - EXEMPLOS DIF√çCEIS) ---
        const dragonQuestions = [
            { q: "DESAFIO MISTO: 'N√≥s ______ que ______ casa √© bonita'.", options: ["achamos / aquela", "achamos / aquilo", "acho / aquela", "acham / essa"], correct: 0, explanation: "Concord√¢ncia (N√≥s achamos) + Pronome (Aquela casa)." },
            { q: "DESAFIO MISTO: Qual frase est√° PERFEITA?", options: ["A princesa comeu a ma√ß√£.", "A princeza comeu a ma√ß√£.", "A princesa comeu a mass√£.", "A princesa comeu h√° ma√ß√£."], correct: 0, explanation: "Princesa com S, Ma√ß√£ com √á." },
            { q: "DRAG√ÉO SUPREMO: O sujeito de 'Ontem, choveu muito' √©:", options: ["Ontem", "Choveu", "Muito", "Inexistente"], correct: 3, explanation: "Fen√¥menos da natureza n√£o t√™m sujeito!" },
            { q: "DRAG√ÉO: Qual palavra tem d√≠grafo (duas letras, um som)?", options: ["Carro", "Casa", "Pato", "Luva"], correct: 0, explanation: "RR em Carro √© um d√≠grafo." },
            { q: "DRAG√ÉO: O plural de 'cidad√£o' √©:", options: ["Cidad√µes", "Cidad√£os", "Cidad√£es", "Cidad√£o"], correct: 1, explanation: "O correto √© Cidad√£os." }
        ];

        // --- ESTADO DO JOGO ---
        let state = {
            screen: 'map',
            currentTopicIndex: null,
            currentQuestionIndex: 0,
            score: 0,
            completedTopics: [],
            dragonStreak: 0,
            dragonRank: "Iniciante"
        };

        const app = document.getElementById('app');
        const scoreDisplay = document.getElementById('global-score');
        const charIcon = document.getElementById('char-icon');
        const charName = document.getElementById('char-name');

        const characters = [
            { min: 0, name: "Ovo Curioso", icon: "ü•ö" },
            { min: 1, name: "Pintinho", icon: "üê£" },
            { min: 3, name: "Coruja", icon: "ü¶â" },
            { min: 5, name: "Mago", icon: "üßô‚Äç‚ôÇÔ∏è" },
            { min: 7, name: "Cavaleiro Real", icon: "ü§¥" }
        ];

        function updateChar() {
            const char = characters.slice().reverse().find(c => state.completedTopics.length >= c.min) || characters[0];
            charIcon.innerText = char.icon;
            charName.innerText = char.name;
        }

        // --- TELA: MAPA ---
        function renderMap() {
            updateChar();
            const allCompleted = state.completedTopics.length === 7;

            app.innerHTML = `
                <div class="text-center mb-6 fade-in">
                    <h2 class="text-3xl font-bold text-gray-800">üó∫Ô∏è Mapa das Lendas</h2>
                    <p class="text-gray-500">Colete as 7 medalhas para abrir o Portal!</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full fade-in pb-10">
                    ${quizData.map((topic, index) => {
                const isDone = state.completedTopics.includes(index);
                return `
                        <div class="bg-white rounded-3xl p-5 shadow-lg border-b-8 ${isDone ? 'border-green-400 bg-green-50' : 'border-gray-200'} relative overflow-hidden">
                            ${isDone ? '<div class="absolute top-0 right-0 bg-green-500 text-white px-3 py-1 text-xs font-bold rounded-bl-xl">COMPLETO</div>' : ''}
                            <div class="flex items-center gap-4 mb-4">
                                <div class="${topic.color} w-14 h-14 rounded-xl flex items-center justify-center text-2xl text-white shadow-md border-2 border-white">
                                    ${topic.icon}
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-gray-800">${topic.title}</h3>
                                    <p class="text-xs text-gray-500">${topic.description}</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="renderStudy(${index})" class="flex-1 bg-blue-100 hover:bg-blue-200 text-blue-600 font-bold py-2 rounded-xl text-sm transition-colors border-b-4 border-blue-200 active:border-b-0 active:translate-y-1">
                                    üìñ Aprender
                                </button>
                                <button onclick="startTopic(${index})" class="flex-1 bg-school-green hover:bg-teal-700 text-white font-bold py-2 rounded-xl text-sm transition-colors border-b-4 border-teal-800 active:border-b-0 active:translate-y-1 btn-3d">
                                    ${isDone ? 'Refazer' : '‚ñ∂Ô∏è Jogar'}
                                </button>
                            </div>
                        </div>`;
            }).join('')}
                </div>

                ${allCompleted ? `
                    <div class="w-full mt-8 fade-in animate-pulse-fast cursor-pointer" onclick="startDragonMode()">
                        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-3xl p-8 shadow-2xl border-b-8 border-indigo-900 text-white text-center transform hover:scale-105 transition-transform relative overflow-hidden">
                            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-30"></div>
                            <h2 class="text-3xl font-black mb-2 text-yellow-300">üêâ PORTAL DOS DRAG√ïES</h2>
                            <p class="mb-4 text-purple-200">Apenas para os mais s√°bios! O desafio infinito.</p>
                            <button class="bg-yellow-400 text-purple-900 font-bold px-8 py-3 rounded-full shadow-lg text-xl hover:bg-yellow-300 transition-colors">
                                ENTRAR NO DESAFIO
                            </button>
                        </div>
                    </div>
                ` : `
                    <div class="w-full mt-4 text-center p-4 bg-gray-200 rounded-xl border-dashed border-4 border-gray-300 text-gray-400">
                        üîí O Portal Secreto est√° trancado. <br>Conquiste todas as 7 medalhas para ver o que tem aqui!
                    </div>
                `}
            `;
            window.scrollTo(0, 0);
        }

        // --- TELA: ESCOLINHA (TUTORIAL) ---
        function renderStudy(index) {
            const topic = quizData[index];
            app.innerHTML = `
                <div class="w-full max-w-2xl bg-white rounded-3xl shadow-xl border-b-8 border-blue-200 p-8 fade-in relative">
                    <button onclick="renderMap()" class="absolute top-4 left-4 text-gray-400 hover:text-gray-600 font-bold">‚¨Ö Voltar</button>
                    
                    <div class="text-center mt-6 mb-8">
                        <div class="${topic.color} w-20 h-20 rounded-full flex items-center justify-center text-4xl text-white shadow-lg mx-auto mb-4 border-4 border-white">
                            ${topic.icon}
                        </div>
                        <h2 class="text-3xl font-bold text-gray-800">${topic.study.title}</h2>
                        <p class="text-lg text-gray-600 mt-2">${topic.study.content}</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                        ${topic.study.cards.map(card => `
                            <div class="bg-blue-50 p-4 rounded-2xl border-2 border-blue-100 flex items-center gap-3">
                                <span class="text-3xl">${card.emoji}</span>
                                <span class="font-bold text-gray-700 leading-tight">${card.text}</span>
                            </div>
                        `).join('')}
                    </div>

                    <button onclick="startTopic(${index})" class="w-full bg-school-green hover:bg-teal-700 text-white font-bold py-4 rounded-xl text-xl shadow-lg btn-3d">
                        Entendi! Quero Jogar! üöÄ
                    </button>
                </div>
            `;
            window.scrollTo(0, 0);
        }

        // --- INICIAR JOGO NORMAL ---
        function startTopic(index) {
            state.screen = 'game';
            state.currentTopicIndex = index;
            state.currentQuestionIndex = 0;
            renderQuestion();
        }

        function renderQuestion() {
            const topic = quizData[state.currentTopicIndex];
            const question = topic.questions[state.currentQuestionIndex];

            app.innerHTML = `
                <div class="w-full mb-4 px-2 flex justify-between">
                    <button onclick="renderMap()" class="text-gray-400 font-bold text-sm">‚¨Ö Sair</button>
                    <span class="text-school-blue font-bold text-xs uppercase">${topic.title} ‚Ä¢ ${state.currentQuestionIndex + 1}/${topic.questions.length}</span>
                </div>
                
                <div class="bg-white w-full rounded-3xl shadow-xl border-b-8 border-gray-200 p-6 relative fade-in">
                    <div class="inline-block px-3 py-1 rounded-full bg-gray-100 text-gray-500 text-xs font-bold uppercase mb-4">${question.level}</div>
                    <h2 class="text-xl md:text-2xl text-gray-800 font-bold mb-6">${formatText(question.q)}</h2>
                    <div class="grid gap-3" id="opts">
                        ${question.options.map((opt, idx) => `
                            <button onclick="checkAnswer(${idx})" id="opt-${idx}" class="w-full text-left p-4 rounded-xl border-2 border-gray-100 bg-gray-50 hover:bg-blue-50 font-semibold text-gray-600 btn-3d flex gap-3">
                                <div class="w-8 h-8 rounded-full bg-white border border-gray-300 flex items-center justify-center text-sm">${['A', 'B', 'C', 'D'][idx]}</div>
                                ${formatText(opt)}
                            </button>
                        `).join('')}
                    </div>
                    <div id="feedback"></div>
                </div>
            `;
            window.scrollTo(0, 0);
        }

        function checkAnswer(idx) {
            const topic = quizData[state.currentTopicIndex];
            const q = topic.questions[state.currentQuestionIndex];
            const isCorrect = idx === q.correct;

            document.querySelectorAll('#opts button').forEach(b => b.disabled = true);
            const btn = document.getElementById(`opt-${idx}`);

            if (isCorrect) {
                btn.className = "w-full text-left p-4 rounded-xl bg-green-100 border-2 border-green-500 text-green-800 font-bold flex gap-3";
                state.score += 10;
                confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 } });
            } else {
                btn.className = "w-full text-left p-4 rounded-xl bg-red-100 border-2 border-red-400 text-red-800 font-bold flex gap-3";
                document.getElementById(`opt-${q.correct}`).classList.add('bg-green-50', 'border-green-300', 'text-green-700');
            }
            updateScore();

            const isLast = state.currentQuestionIndex === topic.questions.length - 1;
            document.getElementById('feedback').innerHTML = `
                <div class="mt-6 p-4 rounded-xl ${isCorrect ? 'bg-green-50' : 'bg-orange-50'} border fade-in">
                    <p class="font-bold ${isCorrect ? 'text-green-600' : 'text-orange-600'} text-lg">${isCorrect ? 'Muito bem!' : 'Ops!'}</p>
                    <p class="text-gray-700 mt-1">${q.explanation}</p>
                    <button onclick="${isLast ? 'finishTopic()' : 'nextQ()'}" class="mt-4 w-full bg-school-green text-white font-bold py-3 rounded-lg btn-3d">
                        ${isLast ? 'Concluir Fase' : 'Pr√≥xima'}
                    </button>
                </div>
            `;
        }

        function nextQ() { state.currentQuestionIndex++; renderQuestion(); }

        function finishTopic() {
            if (!state.completedTopics.includes(state.currentTopicIndex)) state.completedTopics.push(state.currentTopicIndex);
            confetti({ particleCount: 150, spread: 100 });
            renderMap();
            // Pequeno delay para renderizar o mapa antes do alerta
            setTimeout(() => alert(`Parab√©ns! Voc√™ completou a fase: ${quizData[state.currentTopicIndex].title}!`), 300);
        }

        // --- MODO DRAG√ÉO (ENDGAME) ---
        function startDragonMode() {
            state.dragonStreak = 0;
            state.dragonRank = "Drag√£o de Bronze";
            renderDragonQuestion();
        }

        function renderDragonQuestion() {
            const q = dragonQuestions[Math.floor(Math.random() * dragonQuestions.length)];
            let rankColor = "text-yellow-600";
            if (state.dragonStreak >= 5) { state.dragonRank = "Drag√£o de Prata"; rankColor = "text-gray-400"; }
            if (state.dragonStreak >= 10) { state.dragonRank = "Drag√£o Dourado"; rankColor = "text-yellow-400"; }
            if (state.dragonStreak >= 15) { state.dragonRank = "Drag√£o Supremo"; rankColor = "text-purple-400"; }
            if (state.dragonStreak >= 20) { state.dragonRank = "DEUS DRAG√ÉO"; rankColor = "text-red-500 animate-pulse"; }

            app.innerHTML = `
                <div class="w-full min-h-screen bg-gray-900 absolute top-0 left-0 p-6 flex flex-col items-center z-50">
                    <div class="w-full max-w-2xl">
                        <div class="flex justify-between items-center text-white mb-6">
                            <button onclick="renderMap()" class="text-gray-400 hover:text-white font-bold border border-gray-600 px-3 py-1 rounded-lg">‚ùå Sair</button>
                            <div class="text-right">
                                <p class="text-xs text-gray-400 uppercase">Sequ√™ncia</p>
                                <p class="text-2xl font-black text-white">üî• ${state.dragonStreak}</p>
                            </div>
                        </div>

                        <div class="text-center mb-8">
                            <span class="text-6xl filter drop-shadow-lg">üê≤</span>
                            <h2 class="text-2xl font-black uppercase mt-2 ${rankColor}">${state.dragonRank}</h2>
                        </div>

                        <div class="bg-gray-800 rounded-3xl p-6 border-2 border-gray-700 shadow-2xl relative">
                            <h2 class="text-xl text-white font-bold mb-6">${formatText(q.q)}</h2>
                            <div class="grid gap-3" id="dragon-opts">
                                ${q.options.map((opt, idx) => `
                                    <button onclick="checkDragon(${idx}, ${q.correct})" class="w-full text-left p-4 rounded-xl bg-gray-700 hover:bg-gray-600 text-gray-200 border border-gray-600 font-bold transition-all">
                                        ${formatText(opt)}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function checkDragon(idx, correct) {
            const btns = document.querySelectorAll('#dragon-opts button');
            btns.forEach(b => b.disabled = true);

            if (idx === correct) {
                btns[idx].classList.remove('bg-gray-700');
                btns[idx].classList.add('bg-green-600', 'border-green-400', 'text-white');
                state.dragonStreak++;
                state.score += 20;
                updateScore();
                confetti({ particleCount: 30, spread: 50, colors: ['#FFD700', '#FF0000'] });
                setTimeout(renderDragonQuestion, 1500);
            } else {
                btns[idx].classList.remove('bg-gray-700');
                btns[idx].classList.add('bg-red-600', 'text-white');
                btns[correct].classList.add('bg-green-600', 'text-white');
                setTimeout(() => {
                    alert(`O Drag√£o venceu! Sua sequ√™ncia foi: ${state.dragonStreak}`);
                    renderMap();
                }, 2000);
            }
        }

        function formatText(t) { return t.replace(/\*\*(.*?)\*\*/g, '<span class="text-school-blue font-extrabold">$1</span>'); }
        function updateScore() { document.getElementById('global-score').innerText = state.score; }

        renderMap();

        // --- REGISTRO DO SERVICE WORKER (PWA) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((reg) => console.log('Service Worker registrado!', reg.scope))
                    .catch((err) => console.error('Erro no Service Worker:', err));
            });
        }
    </script>
</body>

</html>